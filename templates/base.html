<!doctype html>
<html lang="{{ 'ckb' if lang == 'ku' else 'en' }}" dir="{{ 'rtl' if lang == 'ku' else 'ltr' }}">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta name="format-detection" content="telephone=no,email=no,address=no" />
  <meta name="theme-color" content="#0A0A0F" />
  <title>{{ title or t('app.name') }}</title>

  <link rel="icon" type="image/png" href="{{ url_for('static', filename='favicon.png') }}">
  <link rel="apple-touch-icon" href="{{ url_for('static', filename='favicon.png') }}">

  <script>
    (function () {
      const stored = localStorage.getItem('theme');
      if (stored === 'light' || stored === 'dark') {
        document.documentElement.setAttribute('data-theme', stored);
        const themeMeta = document.querySelector('meta[name="theme-color"]');
        if (themeMeta) {
          themeMeta.setAttribute('content', stored === 'light' ? '#e2e8f0' : '#0A0A0F');
        }
      }
    })();
  </script>

  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Vazirmatn:wght@400;500;600;700;800&family=Noto+Naskh+Arabic:wght@400;600;700&display=swap" rel="stylesheet">

  <script src="https://cdn.tailwindcss.com"></script>

  <style>
    :root {
      --bg: #0A0A0F;
      --bg-elev-1: #0F1017;
      --bg-elev-2: #12121B;
      --bg-elev-3: #171725;

      --border: rgba(255, 255, 255, 0.10);
      --divider: rgba(255, 255, 255, 0.07);

      --text: #F2F3F7;
      --text-2: #B7BAC7;
      --text-3: #7D8196;

      --accent: #8B5CF6;
      --accent-soft: rgba(139, 92, 246, 0.14);
      --accent-border: rgba(139, 92, 246, 0.28);
      --focus: rgba(139, 92, 246, 0.35);

      /* Kept for existing code that references it */
      --page-bg: var(--bg);
    }
    :root[data-theme="light"] {
      --page-bg: #e2e8f0;
    }
    html,
    body {
      background-color: var(--page-bg);
    }
    html {
      -webkit-overflow-scrolling: touch;
      scroll-behavior: smooth;
    }
    body {
      background:
        radial-gradient(900px circle at 50% -20%, rgba(139, 92, 246, 0.10), transparent 55%),
        linear-gradient(135deg, var(--bg) 0%, var(--bg) 100%);
      color: var(--text);
      font-family: "Vazirmatn", "Noto Naskh Arabic", "Noto Sans Arabic", system-ui, -apple-system, "Segoe UI", sans-serif;
      -webkit-font-smoothing: antialiased;
      -moz-osx-font-smoothing: grayscale;
      touch-action: pan-y;
    }
    
    /* Mobile bottom nav spacing */
    @media (max-width: 640px) {
      body {
        padding-bottom: 80px;
      }
      /* Reduce backdrop-filter on mobile for better performance */
      .card {
        backdrop-filter: blur(8px);
      }
      .header-shell {
        backdrop-filter: blur(8px);
      }
    }

    /* Map common Tailwind text utilities to the palette (dark mode). */
    .text-slate-100 { color: var(--text) !important; }
    .text-slate-200 { color: var(--text-2) !important; }
    .text-slate-300 { color: var(--text-2) !important; }
    .text-slate-400 { color: var(--text-3) !important; }
    .card {
      backdrop-filter: blur(16px);
      background: rgba(18, 18, 27, 0.75);
      border: 1px solid var(--border);
      box-shadow: 0 12px 40px rgba(0,0,0,0.5), 0 2px 8px rgba(0,0,0,0.2);
      transform: translateZ(0);
    }
    .header-shell {
      backdrop-filter: blur(12px);
      background: rgba(15, 16, 23, 0.75);
      border: 1px solid rgba(255,255,255,0.08);
      transform: translateZ(0);
    }
    
    /* Mobile bottom navigation */
    @media (max-width: 640px) {
      .mobile-bottom-nav {
        position: fixed;
        bottom: 0;
        left: 0;
        right: 0;
        z-index: 50;
        backdrop-filter: blur(12px);
        background: rgba(15, 16, 23, 0.95);
        border-top: 1px solid rgba(255,255,255,0.08);
        box-shadow: 0 -4px 20px rgba(0,0,0,0.3);
        padding: 0.5rem 0;
        transform: translateZ(0);
        -webkit-transform: translateZ(0);
      }
      .mobile-bottom-nav nav {
        display: grid;
        grid-template-columns: repeat(4, 1fr);
        gap: 0.25rem;
        padding: 0 0.5rem;
      }
      .mobile-nav-item {
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        padding: 0.5rem;
        border-radius: 1rem;
        transition: all 0.2s ease;
        position: relative;
        text-decoration: none;
      }
      .mobile-nav-item svg {
        width: 1.5rem;
        height: 1.5rem;
        margin-bottom: 0.25rem;
        transition: transform 0.2s ease;
      }
      .mobile-nav-item span {
        font-size: 0.65rem;
        font-weight: 500;
      }
      .mobile-nav-item.active {
        background: rgba(139, 92, 246, 0.15);
      }
      .mobile-nav-item.active::before {
        content: '';
        position: absolute;
        top: 0;
        left: 50%;
        transform: translateX(-50%);
        width: 32px;
        height: 3px;
        background: var(--accent);
        border-radius: 0 0 3px 3px;
      }
      .mobile-nav-item.active svg {
        color: var(--accent);
        transform: scale(1.1);
      }
      .mobile-nav-item:not(.active):hover {
        background: rgba(255, 255, 255, 0.05);
      }
      
      /* Hide desktop nav on mobile */
      #topNav {
        display: none !important;
      }
    }
    
    /* Desktop nav improvements */
    @media (min-width: 641px) {
      .mobile-bottom-nav {
        display: none;
      }
    }
    
    #appHeader {
      transition: border-radius .25s ease, box-shadow .25s ease, transform .2s ease;
    }
    .header-shell.docked {
      border-top-left-radius: 0 !important;
      border-top-right-radius: 0 !important;
      border-bottom-left-radius: 1.5rem !important;
      border-bottom-right-radius: 1.5rem !important;
    }
    .soft {
      background: rgba(15, 16, 23, 0.60);
      border: 1px solid rgba(255,255,255,0.10);
      transform: translateZ(0);
    }
    .input {
      background: rgba(18, 18, 27, 0.85);
      border: 1px solid rgba(255,255,255,0.12);
      color: var(--text);
      text-align: start;
      transition: all 0.2s ease;
    }
    .input:focus {
      background: rgba(18, 18, 27, 0.95);
      border-color: var(--accent);
      box-shadow: 0 0 0 3px var(--focus);
    }
    .input::placeholder { color: rgba(183, 186, 199, 0.70); }
a[href^="mailto"],
    a[x-apple-data-detectors],
    a[x-apple-data-detectors-type="email"] {
      color: inherit !important;
      text-decoration: none !important;
    }
    .menu-panel {
      opacity: 0;
      transform: translateY(-8px) scale(0.98);
      pointer-events: none;
      transition: opacity .18s ease, transform .18s ease;
      background: rgba(18, 18, 27, 0.96);
      border: 1px solid rgba(255, 255, 255, 0.12);
      box-shadow: 0 24px 60px rgba(0, 0, 0, 0.55);
      will-change: opacity, transform;
      -webkit-transform: translateY(-8px) scale(0.98);
    }
.menu-panel.open {
      opacity: 1;
      transform: translateY(0) scale(1);
      pointer-events: auto;
    }
    .menu-backdrop {
      opacity: 0;
      pointer-events: none;
      transition: opacity .18s ease;
    }
    .menu-backdrop.open {
      opacity: 1;
      pointer-events: auto;
    }


    button {
      transition: transform .15s ease, box-shadow .15s ease;
    }
    button:hover:not(:disabled):not(.no-hover) {
      transform: translateY(-1px);
      box-shadow: 0 4px 12px rgba(0,0,0,0.3);
    }
    button:active:not(:disabled):not(.no-hover) {
      transform: translateY(0);
    }
    button:disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }
    
    /* Floating Action Button */
    .fab {
      position: fixed !important;
      bottom: 90px !important;
      right: 1rem !important;
      z-index: 40 !important;
      width: 56px !important;
      height: 56px !important;
      border-radius: 50% !important;
      background: linear-gradient(135deg, var(--accent), #a855f7) !important;
      box-shadow: 0 8px 24px rgba(139, 92, 246, 0.4), 0 2px 8px rgba(0,0,0,0.3) !important;
      display: flex !important;
      align-items: center !important;
      justify-content: center !important;
      transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1), box-shadow 0.3s cubic-bezier(0.4, 0, 0.2, 1);
      border: none !important;
      cursor: pointer !important;
    }
    .fab:hover {
      transform: scale(1.1) translateY(-2px) !important;
      box-shadow: 0 12px 32px rgba(139, 92, 246, 0.5), 0 4px 12px rgba(0,0,0,0.4) !important;
    }
    .fab:active {
      transform: scale(0.95) !important;
    }
    /* Expense form visibility - prevent layout shift */
    #desktopExpenseForm {
      display: none;
    }
    @media (min-width: 641px) {
      .fab {
        display: none !important;
      }
      #expenseModal {
        display: none !important;
      }
      #desktopExpenseForm {
        display: block;
      }
    }
    :root[data-theme="light"] body {
      background:
        radial-gradient(900px circle at 15% 5%, rgba(99, 102, 241, 0.12), transparent 45%),
        radial-gradient(800px circle at 85% 0%, rgba(236, 72, 153, 0.10), transparent 50%),
        linear-gradient(135deg, #e2e8f0 0%, #e7e5e4 45%, #f1e7f0 100%) !important;
      color: #0f172a;
    }
    :root[data-theme="light"] html,
    :root[data-theme="light"] body {
      background-color: var(--page-bg);
    }
    :root[data-theme="light"] .card {
      background: rgba(255, 255, 255, 0.95);
      border: 1px solid rgba(15, 23, 42, 0.1);
      box-shadow: 0 12px 40px rgba(15, 23, 42, 0.08), 0 2px 8px rgba(15, 23, 42, 0.04);
    }
    :root[data-theme="light"] .header-shell {
      background: rgba(255, 255, 255, 0.85);
      border: 1px solid rgba(15, 23, 42, 0.08);
    }
    :root[data-theme="light"] .mobile-bottom-nav {
      background: rgba(255, 255, 255, 0.95);
      border-top: 1px solid rgba(15, 23, 42, 0.08);
      box-shadow: 0 -4px 20px rgba(15, 23, 42, 0.08);
    }
    :root[data-theme="light"] .mobile-nav-item:not(.active):hover {
      background: rgba(15, 23, 42, 0.05);
    }
    :root[data-theme="light"] .menu-panel {
      background: rgba(255, 255, 255, 0.98);
      border: 1px solid rgba(15, 23, 42, 0.12);
      box-shadow: 0 18px 50px rgba(15, 23, 42, 0.12);
    }
    :root[data-theme="light"] .soft {
      background: rgba(203, 213, 225, 0.75);
      border: 1px solid rgba(15, 23, 42, 0.1);
    }
    :root[data-theme="light"] .input {
      background: rgba(255, 255, 255, 0.98);
      border: 1px solid rgba(15, 23, 42, 0.14);
      color: #0f172a;
    }
    :root[data-theme="light"] .input:focus {
      background: #ffffff;
      border-color: var(--accent);
    }
    :root[data-theme="light"] .input::placeholder { color: rgba(71, 85, 105, 0.75); }

    :root[data-theme="light"] .text-slate-100 { color: #0f172a !important; }
    :root[data-theme="light"] .text-slate-200 { color: #1e293b !important; }
    :root[data-theme="light"] .text-slate-300 { color: #334155 !important; }
    :root[data-theme="light"] .text-slate-400 { color: #475569 !important; }

    :root[data-theme="light"] .bg-white\/5 { background-color: rgba(15, 23, 42, 0.04) !important; }
    :root[data-theme="light"] .bg-white\/10 { background-color: rgba(15, 23, 42, 0.08) !important; }
    :root[data-theme="light"] .bg-white\/15 { background-color: rgba(15, 23, 42, 0.12) !important; }
    :root[data-theme="light"] .bg-black\/30 { background-color: rgba(15, 23, 42, 0.12) !important; }
    :root[data-theme="light"] .bg-black\/40 { background-color: rgba(15, 23, 42, 0.16) !important; }
    :root[data-theme="light"] .bg-black\/70 { background-color: rgba(15, 23, 42, 0.45) !important; }

    :root[data-theme="light"] .border-white\/10 { border-color: rgba(15, 23, 42, 0.12) !important; }
    :root[data-theme="light"] .border-white\/20 { border-color: rgba(15, 23, 42, 0.18) !important; }
    :root[data-theme="light"] .ring-white\/10 { --tw-ring-color: rgba(15, 23, 42, 0.12) !important; }
    :root[data-theme="light"] .ring-white\/15 { --tw-ring-color: rgba(15, 23, 42, 0.16) !important; }

    .ltr {
      direction: ltr;
      unicode-bidi: embed;
    }
    .text-start { text-align: start; }
    .text-end { text-align: end; }

    .no-scrollbar::-webkit-scrollbar { display: none; }
    .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
    .auth-fixed-header #appHeader {
      position: fixed;
      left: 0;
      right: 0;
      top: 0;
    }
    
    /* Page transition animations */
    @keyframes fadeInUp {
      from {
        opacity: 0;
        transform: translateY(20px);
      }
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }
    
    #appMain > div {
      animation: fadeInUp 0.4s ease-out;
    }
    
    /* Skeleton loading state */
    .skeleton {
      background: linear-gradient(90deg, rgba(255,255,255,0.05) 25%, rgba(255,255,255,0.1) 50%, rgba(255,255,255,0.05) 75%);
      background-size: 200% 100%;
      animation: shimmer 1.5s infinite;
    }
    
    @keyframes shimmer {
      0% { background-position: 200% 0; }
      100% { background-position: -200% 0; }
    }
    
    /* Improved scrollbar for webkit browsers */
    * {
      scrollbar-width: thin;
      scrollbar-color: rgba(139, 92, 246, 0.3) rgba(255, 255, 255, 0.05);
    }

    /* Mobile performance optimizations */
    @media (max-width: 640px) {
      * {
        -webkit-tap-highlight-color: transparent;
      }

      /* Use GPU acceleration for animations on mobile */
      .card, .soft, .mobile-nav-item, button {
        -webkit-transform: translateZ(0);
        transform: translateZ(0);
      }

      /* Fix background to prevent repaint on scroll */
      body {
        background-attachment: fixed;
      }
    }
    
    *::-webkit-scrollbar {
      width: 8px;
      height: 8px;
    }
    
    *::-webkit-scrollbar-track {
      background: rgba(255, 255, 255, 0.05);
      border-radius: 4px;
    }
    
    *::-webkit-scrollbar-thumb {
      background: rgba(139, 92, 246, 0.3);
      border-radius: 4px;
    }
    
    *::-webkit-scrollbar-thumb:hover {
      background: rgba(139, 92, 246, 0.5);
    }
  
  </style>
</head>

{% set ep = request.endpoint or "" %}
{% set is_auth_page = ep in ["login", "register", "forgot_password", "reset_password", "verify_required"] %}
{% set hide_auth_brand = ep in ["login", "register"] %}
{% set is_fixed_auth_header = ep in ["login", "register"] and not hide_auth_brand %}

<body class="min-h-screen text-slate-100{% if is_fixed_auth_header %} auth-fixed-header{% endif %}">
  <div id="appRoot" class="max-w-6xl mx-auto px-4 {% if hide_auth_brand %}py-6{% elif is_fixed_auth_header %}pt-24 pb-6{% elif is_auth_page %}pt-0 pb-6{% else %}py-6{% endif %}">
    {% set next_lang = "en" if lang == "ku" else "ku" %}
    <header id="appHeader" class="{% if is_fixed_auth_header %}fixed inset-x-0 top-0{% else %}sticky top-0{% endif %} z-50 {% if is_auth_page %}{% if hide_auth_brand %}px-0 py-0{% else %}px-4 py-6{% endif %}{% else %}header-shell rounded-3xl px-4 py-3 sm:px-6{% endif %}">
      <div class="{% if is_auth_page %}flex flex-col items-center text-center gap-3{% else %}flex flex-col gap-4 sm:grid sm:grid-cols-[auto,1fr,auto] sm:items-center{% endif %}">
        {% if is_auth_page %}
          {% if not hide_auth_brand %}
            <div class="flex flex-col items-center justify-center gap-4">
              <div class="h-24 w-24 rounded-3xl overflow-hidden bg-white/5 ring-2 ring-white/10 shadow-2xl">
                <img src="{{ url_for('static', filename='logo.png') }}" alt="{{ t('common.logo') }}" class="h-full w-full object-cover">
              </div>
              <div class="text-4xl font-bold leading-tight">Jard</div>
            </div>
          {% endif %}
        {% else %}
          <div class="flex items-center justify-between w-full sm:contents">
            <a href="{{ url_for('dashboard') }}" class="flex items-center justify-start gap-3 text-start sm:col-start-1 sm:row-start-1">
              <div class="h-10 w-10 rounded-2xl overflow-hidden bg-white/5 ring-1 ring-white/10">
                <img src="{{ url_for('static', filename='logo.png') }}" alt="{{ t('common.logo') }}" class="h-full w-full object-cover">
              </div>
              <div class="text-xl font-semibold leading-tight">Jard</div>
            </a>
            {% if current_user.is_authenticated and not is_auth_page %}
              <div class="flex justify-center sm:justify-end relative sm:col-start-3 sm:row-start-1 sm:justify-self-end">
                <button id="menuButton"
                        class="inline-flex items-center justify-center w-10 h-10 rounded-2xl bg-white/10 hover:bg-white/15 transition"
                        aria-expanded="false" aria-controls="menuPanel">
                  <span class="sr-only">{{ t('menu.open') }}</span>
                  <svg class="h-5 w-5" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
                    <path stroke-linecap="round" stroke-linejoin="round" d="M4 6h16M4 12h16M4 18h16"/>
                  </svg>
                </button>

                <div id="menuPanel" class="menu-panel absolute {{ 'left-0' if lang == 'ku' else 'right-0' }} top-full mt-2 w-64 card rounded-3xl p-3 z-50">
                  <div class="flex flex-col gap-2">
                    <a href="{{ url_for('profile') }}"
                       class="w-full px-4 py-3 rounded-2xl bg-white/10 hover:bg-white/15 transition text-sm font-semibold inline-flex items-center gap-3">
                      <svg class="h-4 w-4" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M20 21a8 8 0 0 0-16 0"/>
                        <circle cx="12" cy="8" r="4"/>
                      </svg>
                      {{ t('menu.profile') }}
                    </a>

                    <button type="button" id="themeToggle" data-theme-toggle
                            class="w-full px-4 py-3 rounded-2xl bg-white/10 hover:bg-white/15 transition text-sm font-semibold inline-flex items-center gap-3">
                      <svg id="themeIconMoon" class="h-4 w-4 hidden" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M21 12.8A9 9 0 1 1 11.2 3a7 7 0 0 0 9.8 9.8z"/>
                      </svg>
                      <svg id="themeIconSun" class="h-4 w-4 hidden" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
                        <circle cx="12" cy="12" r="4"/>
                        <path stroke-linecap="round" stroke-linejoin="round" d="M12 3v2m0 14v2m9-9h-2M5 12H3m14.95 6.95-1.41-1.41M7.46 7.46 6.05 6.05m12.9 0-1.41 1.41M7.46 16.54l-1.41 1.41"/>
                      </svg>
                      <span id="themeToggleLabel">{{ t('menu.switch_theme') }}</span>
                    </button>

                    <form method="post" action="{{ url_for('set_language') }}">
                      <input type="hidden" name="lang" value="{{ next_lang }}">
                      <input type="hidden" name="next" value="{{ request.full_path if request.query_string else request.path }}">
                      <button type="submit"
                              class="w-full px-4 py-3 rounded-2xl bg-white/10 hover:bg-white/15 transition text-sm font-semibold inline-flex items-center gap-3">
                        <svg class="h-4 w-4" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
                          <path stroke-linecap="round" stroke-linejoin="round" d="M12 3c4.418 0 8 3.582 8 8 0 3.98-2.91 7.28-6.73 7.88M12 3C7.582 3 4 6.582 4 11c0 3.98 2.91 7.28 6.73 7.88M12 3v16M4 11h16"/>
                        </svg>
                        {{ t('menu.language_to_en') if lang == 'ku' else t('menu.language_to_ku') }}
                      </button>
                    </form>

                    <form method="post" action="{{ url_for('logout') }}">
                      <button class="w-full px-4 py-3 rounded-2xl bg-rose-600 hover:bg-rose-500 transition text-sm font-semibold text-white inline-flex items-center gap-3">
                        <svg class="h-4 w-4" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
                          <path stroke-linecap="round" stroke-linejoin="round" d="M15 3h4a2 2 0 0 1 2 2v14a2 2 0 0 1-2 2h-4"/>
                          <path stroke-linecap="round" stroke-linejoin="round" d="M10 17l5-5-5-5"/>
                          <path stroke-linecap="round" stroke-linejoin="round" d="M15 12H3"/>
                        </svg>
                        {{ t('menu.logout') }}
                      </button>
                    </form>
                  </div>
                </div>
              </div>
            {% endif %}
          </div>
        {% endif %}

        {% if current_user.is_authenticated and not is_auth_page %}
          {% set link_base = "px-3 py-2 rounded-xl transition" %}
          {% set active = "bg-violet-500/15 ring-1 ring-inset ring-violet-400/20" %}
          {% set inactive = "hover:bg-white/10" %}
          <nav id="topNav" class="w-full flex flex-nowrap overflow-x-auto no-scrollbar items-center gap-2 text-sm whitespace-nowrap justify-start sm:justify-center px-2 sm:px-1 sm:col-start-2 sm:row-start-1">
            {% if has_household %}
              <a class="{{ link_base }} {{ active if ep=='dashboard' else inactive }}" href="{{ url_for('dashboard') }}">{{ t('nav.dashboard') }}</a>
              <a class="{{ link_base }} {{ active if ep=='expenses' else inactive }}" href="{{ url_for('expenses') }}">{{ t('nav.expenses') }}</a>
              <a class="{{ link_base }} {{ active if ep=='household' else inactive }}" href="{{ url_for('household') }}">{{ t('nav.household') }}</a>
              <a class="{{ link_base }} {{ active if ep=='archive' else inactive }}" href="{{ url_for('archive') }}">{{ t('nav.archive') }}</a>
            {% endif %}
          </nav>
        {% endif %}
      </div>
    </header>

    <!-- Mobile Bottom Navigation -->
    {% if current_user.is_authenticated and not is_auth_page and has_household %}
    <div class="mobile-bottom-nav">
      <nav>
        <a href="{{ url_for('dashboard') }}" class="mobile-nav-item {{ 'active' if ep=='dashboard' else '' }}">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <rect x="3" y="3" width="7" height="7" rx="1"/>
            <rect x="14" y="3" width="7" height="7" rx="1"/>
            <rect x="14" y="14" width="7" height="7" rx="1"/>
            <rect x="3" y="14" width="7" height="7" rx="1"/>
          </svg>
          <span>{{ t('nav.dashboard') }}</span>
        </a>
        <a href="{{ url_for('expenses') }}" class="mobile-nav-item {{ 'active' if ep=='expenses' else '' }}">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <path stroke-linecap="round" stroke-linejoin="round" d="M12 2v20M17 5H9.5a3.5 3.5 0 0 0 0 7h5a3.5 3.5 0 0 1 0 7H6"/>
          </svg>
          <span>{{ t('nav.expenses') }}</span>
        </a>
        <a href="{{ url_for('household') }}" class="mobile-nav-item {{ 'active' if ep=='household' else '' }}">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <path stroke-linecap="round" stroke-linejoin="round" d="M3 9l9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"/>
            <path stroke-linecap="round" stroke-linejoin="round" d="M9 22V12h6v10"/>
          </svg>
          <span>{{ t('nav.household') }}</span>
        </a>
        <a href="{{ url_for('archive') }}" class="mobile-nav-item {{ 'active' if ep=='archive' else '' }}">
          <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <path stroke-linecap="round" stroke-linejoin="round" d="M21 8v13H3V8"/>
            <path stroke-linecap="round" stroke-linejoin="round" d="M1 3h22v5H1z"/>
            <path stroke-linecap="round" stroke-linejoin="round" d="M10 12h4"/>
          </svg>
          <span>{{ t('nav.archive') }}</span>
        </a>
      </nav>
    </div>
    {% endif %}

    <div id="menuBackdrop" class="menu-backdrop fixed inset-0 bg-black/40 z-40"></div>

    <div id="flashMessages">
      {% with messages = get_flashed_messages(with_categories=true) %}
        {% if messages %}
          <div class="mt-5 space-y-2 text-center">
          {% for category, message in messages %}
            {% set bg = "bg-emerald-500/15 ring-emerald-400/20" if category=="success" else
                        "bg-rose-500/15 ring-rose-400/20" if category=="error" else
                        "bg-sky-500/15 ring-sky-400/20" %}
            <div class="px-4 py-3 rounded-2xl ring-1 {{ bg }}">
              <div class="text-sm">{{ message }}</div>
            </div>
          {% endfor %}
          </div>
        {% endif %}
      {% endwith %}
    </div>

    <main id="appMain" class="mt-6 flex flex-col items-center">
      <div class="w-full">
        {% block content %}{% endblock %}
      </div>
    </main>
  </div>

  <!-- Mobile FAB for adding expense (only shown on expenses page) -->
  {% if ep == 'expenses' %}
  <button id="openExpenseFormMobile" style="position: fixed !important; bottom: 90px !important; right: 1rem !important; z-index: 40 !important; width: 56px !important; height: 56px !important; border-radius: 50% !important; background: linear-gradient(135deg, #8B5CF6, #a855f7) !important; box-shadow: 0 8px 24px rgba(139, 92, 246, 0.4), 0 2px 8px rgba(0,0,0,0.3) !important; display: flex !important; align-items: center !important; justify-content: center !important; transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1), box-shadow 0.3s cubic-bezier(0.4, 0, 0.2, 1) !important; border: none !important; cursor: pointer !important; padding: 0 !important; margin: 0 !important;">
    <svg style="width: 1.5rem; height: 1.5rem; color: white;" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5">
      <path stroke-linecap="round" stroke-linejoin="round" d="M12 5v14m7-7H5"/>
    </svg>
  </button>
  <style>
    @media (min-width: 641px) {
      #openExpenseFormMobile {
        display: none !important;
      }
    }
  </style>
  {% endif %}

  <!-- Custom Confirmation Modal -->
  <div id="confirmModal" class="hidden fixed inset-0 z-[100] items-center justify-center p-4" style="background: rgba(0, 0, 0, 0.6); backdrop-filter: blur(4px);">
    <div class="card rounded-3xl p-6 max-w-sm w-full text-center transform transition-all duration-200" id="confirmModalContent" style="opacity: 0; transform: scale(0.95);">
      <div class="text-2xl mb-4">⚠️</div>
      <h3 class="text-xl font-bold mb-3" id="confirmModalMessage"></h3>
      <div class="flex gap-3 mt-6">
        <button id="confirmModalCancel" class="flex-1 py-3 rounded-2xl bg-white/10 hover:bg-white/15 transition font-semibold">
          {{ t('common.cancel') }}
        </button>
        <button id="confirmModalConfirm" class="flex-1 py-3 rounded-2xl bg-rose-600 hover:bg-rose-500 transition font-semibold text-white">
          {{ t('common.confirm') }}
        </button>
      </div>
    </div>
  </div>

  <script>
    (function() {
      const modal = document.getElementById('confirmModal');
      const content = document.getElementById('confirmModalContent');
      const message = document.getElementById('confirmModalMessage');
      const cancelBtn = document.getElementById('confirmModalCancel');
      const confirmBtn = document.getElementById('confirmModalConfirm');
      let resolveCallback = null;

      function showConfirmModal(msg) {
        return new Promise((resolve) => {
          resolveCallback = resolve;
          message.textContent = msg || "{{ t('common.confirm_action') }}";
          modal.classList.remove('hidden');
          modal.classList.add('flex');
          document.body.style.overflow = 'hidden';
          requestAnimationFrame(() => {
            content.style.opacity = '1';
            content.style.transform = 'scale(1)';
          });
        });
      }

      function hideConfirmModal(result) {
        content.style.opacity = '0';
        content.style.transform = 'scale(0.95)';
        setTimeout(() => {
          modal.classList.add('hidden');
          modal.classList.remove('flex');
          document.body.style.overflow = '';
          if (resolveCallback) {
            resolveCallback(result);
            resolveCallback = null;
          }
        }, 200);
      }

      cancelBtn.addEventListener('click', () => hideConfirmModal(false));
      confirmBtn.addEventListener('click', () => hideConfirmModal(true));
      modal.addEventListener('click', (e) => {
        if (e.target === modal) hideConfirmModal(false);
      });

      window.confirmAction = showConfirmModal;
    })();

    function confirmAction(msg) {
      return window.confirmAction(msg);
    }

    (function () {
      function syncHeaderDock() {
        const header = document.getElementById('appHeader');
        if (!header || !header.classList.contains('header-shell')) return;
        const rect = header.getBoundingClientRect();
        const shouldDock = rect.top <= 0.5;
        header.classList.toggle('docked', shouldDock);
      }

      syncHeaderDock();
      window.addEventListener('scroll', () => {
        window.requestAnimationFrame(syncHeaderDock);
      }, { passive: true });

      const root = document.documentElement;

      function currentTheme() {
        return root.getAttribute('data-theme') || 'dark';
      }

      function syncThemeColor() {
        const themeMeta = document.querySelector('meta[name="theme-color"]');
        if (!themeMeta) return;
        const theme = currentTheme();
        themeMeta.setAttribute('content', theme === 'light' ? '#e2e8f0' : '#0A0A0F');
      }

      function syncThemeToggle() {
        const toggle = document.getElementById('themeToggle');
        const label = document.getElementById('themeToggleLabel');
        const iconSun = document.getElementById('themeIconSun');
        const iconMoon = document.getElementById('themeIconMoon');
        if (!toggle || !label) return;
        const active = currentTheme();
        toggle.setAttribute('aria-pressed', active === 'dark' ? 'true' : 'false');
        if (active === 'dark') {
          label.textContent = "{{ t('menu.switch_to_light') }}";
          if (iconSun) iconSun.classList.remove('hidden');
          if (iconMoon) iconMoon.classList.add('hidden');
        } else {
          label.textContent = "{{ t('menu.switch_to_dark') }}";
          if (iconSun) iconSun.classList.add('hidden');
          if (iconMoon) iconMoon.classList.remove('hidden');
        }
      }

      function setTheme(theme) {
        root.setAttribute('data-theme', theme);
        localStorage.setItem('theme', theme);
        syncThemeColor();
        syncThemeToggle();
      }

      function getMenuEls() {
        return {
          button: document.getElementById('menuButton'),
          panel: document.getElementById('menuPanel'),
          backdrop: document.getElementById('menuBackdrop'),
        };
      }

      function openMenu() {
        const { button, panel, backdrop } = getMenuEls();
        if (!button || !panel) return;
        panel.classList.add('open');
        if (backdrop) backdrop.classList.add('open');
        button.setAttribute('aria-expanded', 'true');
      }

      function closeMenu() {
        const { button, panel, backdrop } = getMenuEls();
        if (!button || !panel) return;
        panel.classList.remove('open');
        if (backdrop) backdrop.classList.remove('open');
        button.setAttribute('aria-expanded', 'false');
      }

      function toggleMenu() {
        const { panel } = getMenuEls();
        if (!panel) return;
        if (panel.classList.contains('open')) closeMenu();
        else openMenu();
      }

      document.addEventListener('click', (e) => {
        const themeBtn = e.target.closest ? e.target.closest('[data-theme-toggle]') : null;
        if (themeBtn) {
          const next = currentTheme() === 'dark' ? 'light' : 'dark';
          setTheme(next);
          return;
        }

        const menuBtn = e.target.closest ? e.target.closest('#menuButton') : null;
        if (menuBtn) {
          toggleMenu();
          return;
        }

        const { panel } = getMenuEls();
        if (panel && panel.classList.contains('open')) {
          const inside = e.target.closest ? e.target.closest('#menuPanel') : null;
          if (!inside) closeMenu();
        }
      });

      document.addEventListener('keydown', (e) => {
        if (e.key === 'Escape') closeMenu();
      });

      window.syncMenuUI = function () {
        syncThemeToggle();
        syncThemeColor();
        closeMenu();
        syncHeaderDock();
      };

      if (!root.getAttribute('data-theme')) {
        root.setAttribute('data-theme', 'dark');
      }
      syncThemeColor();
      syncThemeToggle();
    })();

    // Password toggle function
    window.togglePassword = function(inputId, button) {
      const input = document.getElementById(inputId);
      if (!input) return;
      
      const isPassword = input.type === 'password';
      input.type = isPassword ? 'text' : 'password';
      
      const eyeOpen = button.querySelectorAll('.eye-open');
      const eyeClosed = button.querySelectorAll('.eye-closed');
      
      eyeOpen.forEach(el => el.classList.toggle('hidden', isPassword));
      eyeClosed.forEach(el => el.classList.toggle('hidden', !isPassword));
    };

    // -----------------------------
    // SPA-like navigation for the top tabs (Dashboard / Expenses / etc.)
    // Prevents full-page refreshes when switching between tabs.
    // -----------------------------
    (function () {
      const nav = document.getElementById('topNav');
      const root = document.getElementById('appRoot');
      if (!nav || !root || !window.fetch || !window.history || !window.DOMParser) return;

      const loadedScriptSrc = new Set();

      function sameOrigin(url) {
        try {
          const u = new URL(url, window.location.href);
          return u.origin === window.location.origin;
        } catch (_) {
          return false;
        }
      }

      function isModifiedClick(e) {
        return e.metaKey || e.ctrlKey || e.shiftKey || e.altKey || e.button !== 0;
      }

      async function loadExternalScript(src) {
        if (!src) return;
        if (loadedScriptSrc.has(src)) return;
        loadedScriptSrc.add(src);

        await new Promise((resolve, reject) => {
          const s = document.createElement('script');
          s.src = src;
          s.async = false;
          s.onload = resolve;
          s.onerror = reject;
          document.body.appendChild(s);
        });
      }

      async function runScriptsInOrder(scripts) {
        for (const s of scripts) {
          const src = s.getAttribute('src');
          if (src) {
            await loadExternalScript(new URL(src, window.location.href).toString());
          } else {
            const inline = document.createElement('script');
            // Preserve type if present
            const t = s.getAttribute('type');
            if (t) inline.type = t;
            inline.textContent = s.textContent || '';
            document.body.appendChild(inline);
            // Remove immediately to avoid DOM bloat; it already executed.
            inline.remove();
          }
        }
      }

      function extractAndRemoveScripts(container) {
        if (!container) return [];
        const scripts = Array.from(container.querySelectorAll('script'));
        for (const s of scripts) s.remove();
        return scripts;
      }

      function swapFromDoc(doc) {
        const newHeader = doc.getElementById('appHeader');
        const newFlash = doc.getElementById('flashMessages');
        const newMain = doc.getElementById('appMain');

        const curHeader = document.getElementById('appHeader');
        const curFlash = document.getElementById('flashMessages');
        const curMain = document.getElementById('appMain');

        if (newHeader && curHeader) curHeader.replaceWith(newHeader);
        if (newFlash && curFlash) curFlash.replaceWith(newFlash);
        if (newMain && curMain) curMain.replaceWith(newMain);
        if (window.syncMenuUI) window.syncMenuUI();
      }

      async function navigate(url, { push = true } = {}) {
        const target = new URL(url, window.location.href);

        // If only the hash changes, let the browser handle it.
        if (target.pathname === window.location.pathname && target.search === window.location.search) {
          if (push) window.history.pushState({}, '', target.href);
          if (target.hash) {
            const el = document.getElementById(target.hash.slice(1));
            if (el) el.scrollIntoView({ behavior: 'smooth' });
          }
          return;
        }

        let res;
        try {
          res = await fetch(target.href, {
            method: 'GET',
            headers: { 'X-Requested-With': 'fetch' },
            credentials: 'same-origin'
          });
        } catch (_) {
          window.location.href = target.href;
          return;
        }

        // If server redirects (e.g. not logged in), fall back to normal navigation.
        if (!res.ok || res.redirected) {
          window.location.href = res.url || target.href;
          return;
        }

        const html = await res.text();
        const doc = new DOMParser().parseFromString(html, 'text/html');

        // Update title
        const title = doc.querySelector('title');
        if (title && title.textContent) document.title = title.textContent;

        // Extract scripts from new main BEFORE swapping (scripts inserted via innerHTML won't run).
        const newMain = doc.getElementById('appMain');
        const scripts = extractAndRemoveScripts(newMain);

        // Swap header/flash/main
        swapFromDoc(doc);

        if (push) window.history.pushState({}, '', target.href);

        // Update active navigation state
        updateActiveNav(target.href);

        // Scroll to top like a real navigation.
        // Use 'auto' (valid value); some browsers ignore unknown behavior values.
        window.scrollTo({ top: 0, behavior: 'auto' });

        // Run any scripts that were part of the new page.
        await runScriptsInOrder(scripts);
      }

      function updateActiveNav(url) {
        // Remove active class from all nav items
        const allNavItems = document.querySelectorAll('#topNav a, #menuPanel a, .mobile-bottom-nav a');
        allNavItems.forEach(item => item.classList.remove('active'));

        // Determine which endpoint this URL corresponds to
        const path = new URL(url, window.location.origin).pathname;
        let endpoint = '';

        if (path === '/' || path.startsWith('/dashboard')) endpoint = 'dashboard';
        else if (path.startsWith('/expenses')) endpoint = 'expenses';
        else if (path.startsWith('/household')) endpoint = 'household';
        else if (path.startsWith('/archive')) endpoint = 'archive';
        else if (path.startsWith('/profile')) endpoint = 'profile';

        // Add active class to matching nav items
        if (endpoint) {
          const selector = `#topNav a[href*="${endpoint}"], #menuPanel a[href*="${endpoint}"], .mobile-bottom-nav a[href*="${endpoint}"]`;
          const activeItems = document.querySelectorAll(selector);
          activeItems.forEach(item => {
            const href = item.getAttribute('href');
            if (href && (href === `/${endpoint}` || href.startsWith(`/${endpoint}?`) || href.startsWith(`/${endpoint}/`))) {
              item.classList.add('active');
            }
          });
        }

        // Show/hide FAB button based on endpoint
        const fab = document.getElementById('openExpenseFormMobile');
        if (fab) {
          if (endpoint === 'expenses') {
            fab.style.display = 'flex';
          } else {
            fab.style.display = 'none';
          }
        }
      }

      document.addEventListener('click', (e) => {
        const a = e.target && e.target.closest ? e.target.closest('#topNav a, #menuPanel a, .mobile-bottom-nav a') : null;
        if (!a) return;
        if (a.target && a.target !== '_self') return;
        if (isModifiedClick(e)) return;
        const href = a.getAttribute('href');
        if (!href || href.startsWith('mailto:') || href.startsWith('tel:')) return;
        if (!sameOrigin(href)) return;
        e.preventDefault();
        navigate(href, { push: true });
      });

      window.addEventListener('popstate', () => {
        navigate(window.location.href, { push: false });
      });

      // Initialize FAB visibility on page load
      updateActiveNav(window.location.href);

    })();
  </script>
</body>
</html>
