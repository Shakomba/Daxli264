{% extends "base.html" %}
{% block content %}
<div class="flex flex-col items-center gap-8">
  <div class="card rounded-3xl p-8 w-full max-w-md text-center">
    <div class="mb-6">
      <svg class="w-16 h-16 mx-auto text-violet-400" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
        <rect x="3" y="11" width="18" height="11" rx="2" ry="2"/>
        <path stroke-linecap="round" stroke-linejoin="round" d="M7 11V7a5 5 0 0110 0v4"/>
      </svg>
    </div>
    <h1 class="text-3xl font-bold">{{ t('register.password_step_title') }}</h1>
    <p class="mt-2 text-slate-400">{{ t('register.password_step_subtitle') }}</p>
    <p class="mt-1 text-sm text-violet-300">{{ email }}</p>

    <form id="passwordForm" class="mt-8 space-y-4" method="post" action="{{ url_for('register_password_post') }}">
      <div class="text-start">
        <label class="text-sm text-slate-200">{{ t('register.password_label') }}</label>
        <div class="relative">
          <input id="passwordInput" name="password" type="password" autocomplete="new-password"
                 class="mt-1 w-full px-4 py-3 pr-12 rounded-2xl input focus:outline-none focus:ring-2 focus:ring-violet-400"
                 placeholder="{{ t('register.password_placeholder') }}" autofocus />
          <button type="button" class="no-hover absolute right-3 top-1/2 -translate-y-1/2 p-2 text-slate-400 transition outline-none" onclick="togglePassword('passwordInput', this)">
            <svg class="w-5 h-5" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <path class="eye-open" stroke-linecap="round" stroke-linejoin="round" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"/>
              <path class="eye-open" stroke-linecap="round" stroke-linejoin="round" d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z"/>
              <path class="eye-closed hidden" stroke-linecap="round" stroke-linejoin="round" d="M3 3l18 18M10.584 10.587a2 2 0 002.828 2.83M9.363 5.365A9.466 9.466 0 0112 5c4.478 0 8.268 2.943 9.542 7a9.716 9.716 0 01-1.676 2.635m-1.224 1.224A9.467 9.467 0 0112 19c-4.477 0-8.268-2.943-9.542-7a9.716 9.716 0 011.676-2.635"/>
            </svg>
          </button>
        </div>
      </div>

      <div class="text-start">
        <label class="text-sm text-slate-200">{{ t('register.confirm_password_label') }}</label>
        <div class="relative">
          <input id="confirmPasswordInput" name="confirm_password" type="password" autocomplete="new-password"
                 class="mt-1 w-full px-4 py-3 pr-12 rounded-2xl input focus:outline-none focus:ring-2 focus:ring-violet-400"
                 placeholder="{{ t('register.password_placeholder') }}" />
          <button type="button" class="no-hover absolute right-3 top-1/2 -translate-y-1/2 p-2 text-slate-400 transition outline-none" onclick="togglePassword('confirmPasswordInput', this)">
            <svg class="w-5 h-5" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <path class="eye-open" stroke-linecap="round" stroke-linejoin="round" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"/>
              <path class="eye-open" stroke-linecap="round" stroke-linejoin="round" d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z"/>
              <path class="eye-closed hidden" stroke-linecap="round" stroke-linejoin="round" d="M3 3l18 18M10.584 10.587a2 2 0 002.828 2.83M9.363 5.365A9.466 9.466 0 0112 5c4.478 0 8.268 2.943 9.542 7a9.716 9.716 0 01-1.676 2.635m-1.224 1.224A9.467 9.467 0 0112 19c-4.477 0-8.268-2.943-9.542-7a9.716 9.716 0 011.676-2.635"/>
            </svg>
          </button>
        </div>
        <div id="passwordError" class="mt-2 text-sm text-rose-400 hidden"></div>
      </div>

      <button type="submit" class="w-full py-3 rounded-2xl bg-violet-500 hover:bg-violet-400 transition font-semibold">
        {{ t('common.continue') }}
      </button>
    </form>

    <div class="mt-6">
      <a href="{{ url_for('register') }}" class="text-sm text-slate-400 hover:text-slate-300 transition">
        {{ t('common.back') }}
      </a>
    </div>
  </div>
</div>

<script>
  (function() {
    const form = document.getElementById('passwordForm');
    const passwordInput = document.getElementById('passwordInput');
    const confirmInput = document.getElementById('confirmPasswordInput');
    const errorEl = document.getElementById('passwordError');

    if (!form) return;

    function clearError() {
      errorEl.classList.add('hidden');
      passwordInput.classList.remove('ring-rose-500');
      confirmInput.classList.remove('ring-rose-500');
    }

    passwordInput.addEventListener('input', clearError);
    confirmInput.addEventListener('input', clearError);

    form.addEventListener('submit', async (e) => {
      e.preventDefault();
      const password = passwordInput.value;
      const confirm = confirmInput.value;

      if (!password) {
        errorEl.textContent = '{{ t("register.password_required") }}';
        errorEl.classList.remove('hidden');
        passwordInput.classList.add('ring-rose-500');
        passwordInput.focus();
        return;
      }

      if (!confirm) {
        errorEl.textContent = '{{ t("register.confirm_password_required") }}';
        errorEl.classList.remove('hidden');
        confirmInput.classList.add('ring-rose-500');
        confirmInput.focus();
        return;
      }

      if (password !== confirm) {
        errorEl.textContent = '{{ t("flash.passwords_no_match") }}';
        errorEl.classList.remove('hidden');
        passwordInput.classList.add('ring-rose-500');
        confirmInput.classList.add('ring-rose-500');
        return;
      }

      const submitBtn = form.querySelector('button[type="submit"]');
      const originalText = submitBtn.textContent;
      submitBtn.disabled = true;
      submitBtn.textContent = '...';

      await submitFormAjax(form, {
        onRedirect: (url) => {
          window.location.href = url;
        },
        onError: () => {
          submitBtn.disabled = false;
          submitBtn.textContent = originalText;
        }
      });
    });
  })();
</script>
{% endblock %}
