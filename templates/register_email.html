{% extends "base.html" %}
{% block content %}
<div class="flex flex-col items-center gap-8">
  <div class="card rounded-3xl p-8 w-full max-w-md text-center">
    <div class="mb-6">
      <svg class="w-16 h-16 mx-auto text-violet-400" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
        <path stroke-linecap="round" stroke-linejoin="round" d="M3 8l7.89 5.26a2 2 0 002.22 0L21 8M5 19h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z"/>
      </svg>
    </div>
    <h1 class="text-3xl font-bold">{{ t('register.email_step_title') }}</h1>
    <p class="mt-2 text-slate-400">{{ t('register.email_step_subtitle') }}</p>

    <form id="emailForm" class="mt-8 space-y-4" method="post" action="{{ url_for('register_email_post', next=request.args.get('next')) }}">
      {% if request.args.get('next') %}
        <input type="hidden" name="next" value="{{ request.args.get('next') }}">
      {% endif %}

      <div class="text-start">
        <input id="emailInput" name="email" type="email" autocomplete="email" autocapitalize="none" spellcheck="false"
               class="w-full px-4 py-3 rounded-2xl input focus:outline-none focus:ring-2 focus:ring-violet-400 text-center"
               placeholder="{{ t('register.email_placeholder') }}" dir="ltr" autofocus />
        <div id="emailError" class="mt-2 text-sm text-rose-400 hidden text-center"></div>
      </div>

      <button type="submit" class="w-full py-3 rounded-2xl bg-violet-500 hover:bg-violet-400 transition font-semibold">
        {{ t('common.continue') }}
      </button>
    </form>

    <div class="mt-6 text-sm text-slate-400">
      {{ t('register.have_account_prefix') }}
      <a class="text-violet-300 font-semibold" href="{{ url_for('login', next=request.args.get('next')) }}">{{ t('register.login_link') }}</a>
    </div>
  </div>
</div>

<script>
  (function() {
    const form = document.getElementById('emailForm');
    const emailInput = document.getElementById('emailInput');
    const errorEl = document.getElementById('emailError');

    if (!form || !emailInput) return;

    emailInput.addEventListener('input', () => {
      errorEl.classList.add('hidden');
      emailInput.classList.remove('ring-rose-500');
    });

    form.addEventListener('submit', async (e) => {
      e.preventDefault();
      const email = emailInput.value.trim();

      if (!email) {
        errorEl.textContent = '{{ t("register.email_required") }}';
        errorEl.classList.remove('hidden');
        emailInput.classList.add('ring-rose-500');
        emailInput.focus();
        return;
      }

      if (!email.includes('@')) {
        errorEl.textContent = '{{ t("register.email_invalid") }}';
        errorEl.classList.remove('hidden');
        emailInput.classList.add('ring-rose-500');
        emailInput.focus();
        return;
      }

      const submitBtn = form.querySelector('button[type="submit"]');
      const originalText = submitBtn.textContent;
      submitBtn.disabled = true;
      submitBtn.textContent = '...';

      await submitFormAjax(form, {
        onRedirect: (url) => {
          window.location.href = url;
        },
        onError: () => {
          submitBtn.disabled = false;
          submitBtn.textContent = originalText;
        }
      });
    });
  })();
</script>
{% endblock %}
